<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluation Results | AI Credit Evaluator</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">

    <link rel="stylesheet" href="css/styles.css">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-logo">
                <div class="logo-icon">AI</div>
                <span>CREDIT EVALUATOR</span>
            </a>

                                    <ul class="navbar-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="application.html">Application</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="methodology.html">Docs</a></li>
                <li><a href="contact.html">Contact Us</a></li>
            </ul>

            <div class="navbar-actions">
                <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu" style="margin-right: 0.5rem;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                    <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <a href="login.html" class="btn btn-ghost" id="navLoginBtn" style="padding: 0.6rem 1.5rem;">Login</a>
                <a href="dashboard.html" class="btn btn-primary" id="navDashboardBtn"
                    style="padding: 0.6rem 1.5rem;">Dashboard</a>
            </div>
        </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main style="padding-top: 100px; min-height: 100vh; background: var(--color-bg-primary);">
        <div class="container" style="padding: 3rem 2rem;">
            <!-- Loading State -->
            <div id="loadingState" class="text-center" style="padding: 4rem 2rem;">
                <div class="spinner" style="margin: 0 auto;"></div>
                <p style="margin-top: 1.5rem; color: var(--color-text-secondary);">Loading evaluation results...</p>
            </div>

            <!-- Dashboard Header -->
            <div class="card mb-lg" style="padding: 2rem;">
                <div
                    style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 style="margin-bottom: 0.5rem; font-size: 1.75rem;">Credit Risk Report</h2>
                        <p style="color: var(--color-text-secondary); display: flex; align-items: center; gap: 0.5rem;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            App ID: <span id="displayAppId"
                                style="font-family: monospace; font-weight: 600;">#---</span>
                        </p>
                    </div>
                    <div style="text-align: right;">
                        <div id="decisionBadge" class="status-badge" style="font-size: 1.1rem; padding: 0.5rem 1rem;">--
                        </div>
                        <p id="evaluatedAt"
                            style="font-size: 0.85rem; color: var(--color-text-muted); margin-top: 0.5rem;">--</p>
                    </div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-2 gap-lg mb-xl">
                <!-- Risk Gauge -->
                <div class="card"
                    style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 320px;">
                    <h3 class="card-title mb-lg" style="width: 100%;">Risk Assessment</h3>
                    <div
                        style="position: relative; height: 200px; width: 100%; display: flex; justify-content: center;">
                        <canvas id="riskGaugeChart"></canvas>
                        <div style="position: absolute; bottom: 10px; text-align: center;">
                            <div id="riskScoreValue" style="font-size: 3rem; font-weight: 800; line-height: 1;">--</div>
                            <div style="font-size: 0.85rem; color: var(--color-text-secondary); font-weight: 600;">TRUST
                                SCORE</div>
                        </div>
                    </div>
                    <div id="riskCategory"
                        style="font-weight: 600; margin-top: 1rem; padding: 0.25rem 1rem; border-radius: 20px; background: var(--color-bg-tertiary);">
                        --
                    </div>
                </div>

                <!-- Feature Importance Bar -->
                <div class="card" style="min-height: 320px;">
                    <h3 class="card-title mb-md">Key Decision Drivers</h3>
                    <div style="height: 240px;">
                        <canvas id="featureChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- What-If Simulator -->
            <div class="card mb-xl"
                style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div>
                        <h3 class="card-title">ðŸ§ª What-If Simulator</h3>
                        <p style="color: var(--color-text-secondary); font-size: 0.9rem;">Adjust parameters to see how
                            they impact the risk score.</p>
                    </div>
                    <span class="status-badge"
                        style="background: white; color: var(--color-primary);">Interactive</span>
                </div>

                <div class="grid grid-3 gap-lg">
                    <!-- Slider 1: Loan Amount -->
                    <div class="form-group">
                        <label class="form-label" style="display: flex; justify-content: space-between;">
                            Loan Amount
                            <span id="simAmountVal" style="font-weight: 700;">â‚¹0</span>
                        </label>
                        <input type="range" id="simAmount" class="form-range" min="100000" max="50000000" step="100000"
                            style="width: 100%;">
                    </div>

                    <!-- Slider 2: Tenure -->
                    <div class="form-group">
                        <label class="form-label" style="display: flex; justify-content: space-between;">
                            Tenure (Months)
                            <span id="simTenureVal" style="font-weight: 700;">0</span>
                        </label>
                        <input type="range" id="simTenure" class="form-range" min="6" max="60" step="6"
                            style="width: 100%;">
                    </div>

                    <!-- Slider 3: Revenue -->
                    <div class="form-group">
                        <label class="form-label" style="display: flex; justify-content: space-between;">
                            Annual Revenue
                            <span id="simRevenueVal" style="font-weight: 700;">â‚¹0</span>
                        </label>
                        <input type="range" id="simRevenue" class="form-range" min="500000" max="100000000"
                            step="500000" style="width: 100%;">
                    </div>
                </div>

                <div style="margin-top: 1.5rem; text-align: right;">
                    <button id="btnSimulate" class="btn btn-primary" onclick="runSimulation()">
                        Recalculate Risk
                    </button>
                    <p id="simStatus" style="font-size: 0.8rem; color: var(--color-text-muted); margin-top: 0.5rem;">
                    </p>
                </div>
            </div>

            <!-- Detailed Metrics -->
            <div class="grid grid-2 gap-lg mb-xl">
                <div class="card">
                    <h3 class="card-title mb-md">Financial Health</h3>
                    <div id="applicationDetails" class="grid gap-md">
                        <!-- Injected by JS -->
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title mb-md">AI Model Insights</h3>
                    <div class="metric-item"
                        style="display: flex; justify-content: space-between; padding: 1rem 0; border-bottom: 1px solid var(--color-border);">
                        <span class="label">Confidence Score</span>
                        <span class="value" id="confidence" style="font-weight: 700;">--%</span>
                    </div>
                    <div class="metric-item"
                        style="display: flex; justify-content: space-between; padding: 1rem 0; border-bottom: 1px solid var(--color-border);">
                        <span class="label">Model Version</span>
                        <span class="value" id="modelVersion" style="font-weight: 600;">--</span>
                    </div>

                    <div
                        style="margin-top: 2rem; background: var(--color-bg-secondary); padding: 1rem; border-radius: var(--radius-md);">
                        <p style="font-size: 0.8rem; color: var(--color-text-muted); line-height: 1.5;">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" style="margin-right: 4px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            <strong>Compliance Note:</strong> This automated decision is based on the applicant's
                            provided financial data. Final approval is subject to manual underwriting review.
                        </p>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button class="btn btn-outline" onclick="window.print()" style="margin-right: 1rem;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="margin-right: 8px; vertical-align: text-bottom;">
                        <path d="M6 9V2h12v7"></path>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                        <rect x="6" y="14" width="12" height="8"></rect>
                    </svg>
                    Download Report
                </button>
                <a href="index.html" class="btn btn-primary">New Application</a>
            </div>
        </div>
    </main>

        <!-- Shared Footer -->
    <footer style="background: var(--color-bg-primary); border-top: 1px solid var(--color-border); padding: 4rem 0;">
        <div class="container">
            <div class="grid grid-2 gap-xl">
                <div>
                    <a href="index.html" class="navbar-logo" style="margin-bottom: 1.5rem; display: inline-flex;">
                        <img src="assets/logo.png" alt="CE Logo" class="logo-image">
                        <span style="font-size: 1.5rem;">Credit Evaluator</span>
                    </a>
                    <p style="color: var(--color-text-secondary); line-height: 1.6; max-width: 400px;">
                        Professional AI-driven credit assessment for modern businesses. Fast, transparent, and secure evaluation.
                    </p>
                </div>
                
                <div>
                    <h3 style="margin-bottom: 1.5rem;">Frequently Asked Questions</h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 0.5rem; color: var(--color-text-primary);">What is this site about?</h4>
                        <p style="color: var(--color-text-secondary); font-size: 0.95rem;">
                            This platform uses advanced Machine Learning (XGBoost) to evaluate business creditworthiness instantly. We analyze financial parameters like revenue, EBITDA, and debt service coverage to provide a real-time risk assessment without manual delays.
                        </p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 0.5rem; color: var(--color-text-primary);">How trustworthy is the evaluation?</h4>
                        <p style="color: var(--color-text-secondary); font-size: 0.95rem;">
                            Our system is calibrated on thousands of historical credit records, achieving over 75% accuracy. While we provide a high-confidence "Decision Assistant," final approvals are always reviewed by human underwriters to ensure fairness and compliance.
                        </p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--color-border); text-align: center; color: var(--color-text-muted); font-size: 0.9rem;">
                &copy; 2025 Credit Evaluator. All rights reserved.
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>
    <script src="js/theme.js"></script>
    <script>
        // Global State for Simulation
        let currentAppData = null;
        let riskChartInstance = null;
        let featureChartInstance = null;

        // Initialize theme
        const currentTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);

        document.addEventListener('DOMContentLoaded', async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const evaluationId = urlParams.get('id');

            if (!evaluationId) {
                alert('No evaluation ID provided');
                window.location.href = 'dashboard.html';
                return;
            }

            try {
                const data = await api.getDetailedEvaluation(evaluationId);
                currentAppData = data.application; // Store for simulation
                displayEvaluation(data);
                initSimulator(currentAppData);
            } catch (error) {
                alert(`Error loading evaluation: ${error.message}`);
                console.error(error);
            }
        });

        function displayEvaluation(data) {
            const { evaluation, application, top_features } = data;

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('evaluationContent').style.display = 'block';

            // 1. Text Data Population
            document.getElementById('displayAppId').textContent = application.applicant_id || '#APP-' + Math.floor(Math.random() * 10000);
            document.getElementById('evaluatedAt').textContent = new Date(evaluation.evaluated_at).toLocaleString();
            document.getElementById('modelVersion').textContent = evaluation.model_version;
            document.getElementById('confidence').textContent = `${(evaluation.confidence_score * 100).toFixed(1)}%`;

            // Risk Score
            updateRiskUI(evaluation.risk_score, evaluation.recommendation);

            // 2. Risk Gauge Chart
            renderRiskChart(evaluation.risk_score);

            // 3. Feature Importance Chart (Bar)
            renderFeatureChart(top_features);

            // 4. Detailed Metrics List
            const metricsObj = {
                "Annual Revenue": `â‚¹${formatNumber(application.annual_revenue)}`,
                "Requested Loan": `â‚¹${formatNumber(application.loan_amount_requested)}`,
                "Business Type": application.business_type,
                "Credit History": application.credit_score + " (Bureau Score)",
                "Years Operating": application.years_in_operation,
                "Debt Ratio": ((application.debt_to_income_ratio || 0) * 100).toFixed(1) + '%'
            };

            const metricsListEl = document.getElementById('applicationDetails');
            metricsListEl.innerHTML = Object.entries(metricsObj).map(([key, val]) => `
                <div style="background: var(--color-bg-primary); padding: 1rem; border-radius: 8px; border: 1px solid var(--color-border);">
                    <p style="font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 0.25rem;">${key}</p>
                    <p style="font-weight: 700; font-size: 1rem;">${val}</p>
                </div>
            `).join('');
        }

        // --- Simulator Logic ---
        function initSimulator(appData) {
            // Set initial values
            const amountSlider = document.getElementById('simAmount');
            const tenureSlider = document.getElementById('simTenure');
            const revSlider = document.getElementById('simRevenue');

            amountSlider.value = appData.loan_amount_requested;
            tenureSlider.value = appData.loan_tenure_months || 36;
            revSlider.value = appData.annual_revenue;

            // Update Labels
            document.getElementById('simAmountVal').textContent = 'â‚¹' + formatNumber(amountSlider.value);
            document.getElementById('simTenureVal').textContent = tenureSlider.value + 'm';
            document.getElementById('simRevenueVal').textContent = 'â‚¹' + formatNumber(revSlider.value);

            // Listeners
            amountSlider.oninput = function () { document.getElementById('simAmountVal').textContent = 'â‚¹' + formatNumber(this.value); };
            tenureSlider.oninput = function () { document.getElementById('simTenureVal').textContent = this.value + 'm'; };
            revSlider.oninput = function () { document.getElementById('simRevenueVal').textContent = 'â‚¹' + formatNumber(this.value); };
        }

        async function runSimulation() {
            if (!currentAppData) return;

            const btn = document.getElementById('btnSimulate');
            const statusEl = document.getElementById('simStatus');
            btn.disabled = true;
            btn.textContent = 'Simulating...';
            statusEl.textContent = 'Contacting AI Prediction Engine...';

            // Prepare payload (clone and update)
            const payload = { ...currentAppData };
            payload.loan_amount_requested = parseFloat(document.getElementById('simAmount').value);
            payload.loan_tenure_months = parseInt(document.getElementById('simTenure').value);
            payload.annual_revenue = parseFloat(document.getElementById('simRevenue').value);

            // Recalculate derived fields roughly if needed? 
            // The backend handles derivations in preprocess_application, so sending raw is fine.
            // But we need to make sure we send valid ApplicationCreate schema.
            // currentAppData has internal fields (id, applicant_id, etc) which ApplicationCreate might reject if strict.
            // But ApplicationCreate ignores extras usually.
            // However, `timestamps` (created_at) might cause issue if schema is strict.
            // Let's rely on FastAPI validation ignoring extra fields, or clean it.

            try {
                // Call /api/predict
                const response = await fetch(`${API_BASE_URL}/api/predict/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Simulation failed');

                const result = await response.json();

                // Update UI with new Risk Score
                updateRiskUI(result.risk_score, result.recommendation);
                renderRiskChart(result.risk_score);

                statusEl.textContent = `Scenario updated! Risk Score: ${result.risk_score}`;
                statusEl.style.color = 'var(--color-success)';

            } catch (e) {
                console.error(e);
                statusEl.textContent = 'Simulation Error.';
                statusEl.style.color = 'red';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Recalculate Risk';
            }
        }

        function updateRiskUI(score, recommendation) {
            const roundedScore = Math.round(score);
            document.getElementById('riskScoreValue').textContent = roundedScore;

            const badgeEl = document.getElementById('decisionBadge');
            const catEl = document.getElementById('riskCategory');

            if (recommendation === 'approve') {
                badgeEl.textContent = 'âœ“ APPROVED';
                badgeEl.className = 'status-badge status-success';
                badgeEl.style.background = '#dcfce7'; badgeEl.style.color = '#166534';
                catEl.textContent = 'Low Risk';
                catEl.style.color = 'var(--color-success)';
                catEl.style.background = '#dcfce7';
            } else if (recommendation === 'reject') {
                badgeEl.textContent = 'âœ— REJECTED';
                badgeEl.className = 'status-badge status-high-risk';
                badgeEl.style.background = '#fee2e2'; badgeEl.style.color = '#991b1b';
                catEl.textContent = 'High Risk';
                catEl.style.color = '#ef4444';
                catEl.style.background = '#fee2e2';
            } else {
                badgeEl.textContent = 'âš  REVIEW';
                badgeEl.className = 'status-badge status-warning';
                badgeEl.style.background = '#fef3c7'; badgeEl.style.color = '#92400e';
                catEl.textContent = 'Medium Risk';
                catEl.style.color = '#d97706';
                catEl.style.background = '#fef3c7';
            }
        }

        function renderRiskChart(riskScore) {
            const ctxGauge = document.getElementById('riskGaugeChart').getContext('2d');
            if (riskChartInstance) riskChartInstance.destroy();

            let gaugeColor = '#10b981'; // Green
            if (riskScore > 30) gaugeColor = '#f59e0b'; // Orange
            if (riskScore > 60) gaugeColor = '#ef4444'; // Red

            riskChartInstance = new Chart(ctxGauge, {
                type: 'doughnut',
                data: {
                    labels: ['Risk', 'Safe'],
                    datasets: [{
                        data: [riskScore, 100 - riskScore],
                        backgroundColor: [gaugeColor, '#e5e7eb'],
                        borderWidth: 0,
                        cutout: '80%',
                        circumference: 180,
                        rotation: 270,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        }

        function renderFeatureChart(top_features) {
            const ctxFeature = document.getElementById('featureChart').getContext('2d');
            if (featureChartInstance) featureChartInstance.destroy();

            const top5 = top_features.slice(0, 5);
            const labels = top5.map(f => formatFeatureName(f.feature));
            const values = top5.map(f => f.importance);

            featureChartInstance = new Chart(ctxFeature, {
                type: 'bar',
                indexAxis: 'y',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Impact Score',
                        data: values,
                        backgroundColor: 'rgba(99, 102, 241, 0.7)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { beginAtZero: true, grid: { display: false } },
                        y: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(num);
        }

        function formatFeatureName(name) {
            return name.split('_').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
    </script>
    <script src="js/animations.js"></script>
</body>

</html>

